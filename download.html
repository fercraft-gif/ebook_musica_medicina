<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Download Â· E-book MÃºsica & Ansiedade</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="description"
      content="Ãrea de download do e-book MÃºsica & Ansiedade â€” obrigado pela sua compra!"
    />

    <!-- Fontes modernas (mesmo padrÃ£o do site) -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Inter+Tight:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- CSS principal da landing -->
    <link rel="stylesheet" href="styles.css" />

    <!-- Estilo extra sÃ³ para o cartÃ£o de agradecimento -->
    <style>
      .thankyou-hero {
        min-height: 70vh;
        display: flex;
        align-items: center;
      }

      .thankyou-card {
        max-width: 720px;
        margin: 0 auto;
        padding: 2.5rem 2rem;
        border-radius: 1.5rem;
        background: radial-gradient(circle at top left, #16343f, #020617);
        box-shadow: 0 22px 45px rgba(0, 0, 0, 0.6);
        color: #e5e7eb;
      }

      .thankyou-title {
        font-size: clamp(1.8rem, 3vw, 2.3rem);
        margin-bottom: 0.75rem;
      }

      .thankyou-email {
        font-weight: 600;
        color: #a7f3d0;
        margin: 0.25rem 0 1rem;
      }

      .thankyou-actions {
        margin-top: 2rem;
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .thankyou-note {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-top: 1.25rem;
      }

      .status-text {
        margin-top: 0.75rem;
        font-size: 0.95rem;
        line-height: 1.5;
      }

      .status-ok {
        color: #bbf7d0;
      }

      .status-warn {
        color: #fde68a;
      }

      .status-error {
        color: #fecaca;
      }

      .hidden {
        display: none !important;
      }
    </style>
  </head>

  <body class="page download-page">
    <!-- CabeÃ§alho igual ao resto do site -->
    <header class="site-header">
      <div class="container header-inner">
        <div class="logo-block">
          <div class="logo-mark">OA</div>
          <div class="logo-text">
            <span class="logo-small">Octopus Axis E-books</span>
            <span class="logo-sub">SÃ©rie MÃºsica &amp; Medicina</span>
          </div>
        </div>
      </div>
    </header>

    <main class="thankyou-hero">
      <div class="container">
        <div class="thankyou-card">
          <p class="pill">Compra concluÃ­da Â· MÃºsica &amp; Ansiedade</p>

          <h1 class="thankyou-title" id="download-title">
            Obrigada por confiar no meu trabalho.
          </h1>

          <p id="download-message">
            Estamos confirmando seu pagamento e preparando o download seguro do
            e-book.
          </p>

          <p class="thankyou-email" id="buyer-email-display"></p>

          <p id="download-status" class="status-text status-warn">
            Buscando seu pedidoâ€¦
          </p>

          <div class="thankyou-actions">
            <button
              id="retry-button"
              type="button"
              class="btn btn-primary hidden"
            >
              Abrir e-book novamente
            </button>

            <a href="index.html" class="btn btn-outline">
              Voltar para a pÃ¡gina inicial
            </a>
          </div>

          <p class="thankyou-note">
            Se algo nÃ£o funcionar ou o e-book nÃ£o abrir, me escreva em
            <strong>mt.fernandazaguini@gmail.com</strong> com o comprovante de
            pagamento, que eu te ajudo pessoalmente.
          </p>
        </div>
      </div>
    </main>

    <footer class="site-footer">
      <div class="container footer-inner">
        <p class="footer-text">
          Â© <span id="year"></span> MÃºsica &amp; Ansiedade Â· SÃ©rie MÃºsica &amp;
          Medicina Â· Octopus Axis
        </p>
      </div>
    </footer>

<script>
  // Ano no rodapÃ©
  document.getElementById("year").textContent = new Date().getFullYear();

  const titleEl = document.getElementById("download-title");
  const msgEl = document.getElementById("download-message");
  const statusEl = document.getElementById("download-status");
  const emailEl = document.getElementById("buyer-email-display");
  const retryBtn = document.getElementById("retry-button");

  function setStatus(message, mode) {
    statusEl.textContent = message || "";
    statusEl.classList.remove("status-ok", "status-warn", "status-error");

    if (!message) return;

    if (mode === "ok") statusEl.classList.add("status-ok");
    else if (mode === "error") statusEl.classList.add("status-error");
    else statusEl.classList.add("status-warn");
  }

  function getQueryParam(name) {
    try {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    } catch {
      return null;
    }
  }

  async function iniciarDownload() {
    const email = getQueryParam("email");
    const orderId = getQueryParam("orderId");

    // ðŸ”’ SeguranÃ§a: sÃ³ libera se veio do Mercado Pago
    if (!email || !orderId) {
      msgEl.textContent =
        "Este link precisa vir do retorno do Mercado Pago para liberar o download.";
      setStatus(
        "Link incompleto. Volte ao checkout e clique em â€œRetornar ao siteâ€ apÃ³s o pagamento.",
        "error"
      );
      emailEl.textContent = email || "";
      return;
    }

    emailEl.textContent = email;
    setStatus("Verificando pagamentoâ€¦", "warn");

    try {
      const resp = await fetch(
        `/api/download?email=${encodeURIComponent(email)}&orderId=${encodeURIComponent(orderId)}`,
        { cache: "no-store" }
      );

      const data = await resp.json();

      if (!resp.ok) {
        console.error("Erro /api/download:", data);
        setStatus("Erro ao verificar o pagamento.", "error");
        return;
      }

      if (!data.allowed) {
        setStatus(
          "Pagamento ainda nÃ£o confirmado (status: " +
            (data.mpStatus || "pendente") +
            ").",
          "warn"
        );
        msgEl.textContent =
          "Assim que o pagamento for aprovado, o download serÃ¡ liberado automaticamente.";
        return;
      }

      // âœ… DOWNLOAD LIBERADO
      const ebookUrl = data.ebookUrl;

      if (!ebookUrl) {
        setStatus(
          "Erro ao gerar o link do e-book. Entre em contato por e-mail.",
          "error"
        );
        return;
      }

      setStatus("Pagamento confirmado! Abrindo o e-bookâ€¦", "ok");
      titleEl.textContent = "Obrigada por confiar no meu trabalho ðŸ’š";
      msgEl.textContent =
        "Se o PDF nÃ£o abrir automaticamente, use o botÃ£o abaixo.";

      // botÃ£o manual
      retryBtn.classList.remove("hidden");
      retryBtn.onclick = () => {
        window.open(ebookUrl, "_blank", "noopener,noreferrer");
      };

      // redirecionamento automÃ¡tico (mesma aba â€“ mais estÃ¡vel)
      setTimeout(() => {
        window.location.href = ebookUrl;
      }, 1200);

      return;
    } catch (err) {
      console.error("Erro inesperado:", err);
      setStatus(
        "Erro inesperado ao liberar o download. Tente novamente.",
        "error"
      );
    }
  }

  document.addEventListener("DOMContentLoaded", iniciarDownload);
</script>
  </body>
</html>
