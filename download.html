<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Download · E-book Música & Ansiedade</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="description"
      content="Área de download do e-book Música & Ansiedade — acesse seu PDF usando o e-mail da compra."
    />

    <!-- Fontes modernas (igual ao index.html) -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Inter+Tight:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- CSS principal -->
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body class="page download-page">
    <header class="site-header">
      <div class="container header-inner">
        <a href="/" class="brand">
          <span class="brand-tagline">Série Música &amp; Medicina</span>
          <span class="brand-title">Música &amp; Ansiedade</span>
        </a>
      </div>
    </header>

    <main class="download-main">
      <section class="download-section">
        <div class="download-container">
          <h1 class="download-title">Baixar seu e-book</h1>

          <p class="download-subtitle">
            Informe o <strong>e-mail que você usou na compra</strong> para que o sistema
            encontre seu pedido. Se o pagamento já estiver aprovado, o link para o PDF
            é liberado aqui mesmo, de forma automática.
          </p>

          <form id="download-form" class="download-form">
            <div>
              <label class="form-label" for="email">
                E-mail usado na compra
              </label>
              <input
                id="email"
                name="email"
                type="email"
                required
                autocomplete="email"
                placeholder="seuemail@exemplo.com"
                class="form-input"
              />
            </div>

            <div>
              <label class="form-label" for="orderId">
                ID do pedido (opcional)
              </label>
              <input
                id="orderId"
                name="orderId"
                type="text"
                placeholder="Se você tiver o ID, cole aqui"
                class="form-input"
              />
            </div>

            <button id="download-button" type="submit" class="btn btn-primary">
              Verificar e liberar download
            </button>
          </form>

          <div id="download-status" class="download-status" aria-live="polite"></div>
          

          <p class="download-help-text">
            Se o sistema indicar que o pagamento ainda não foi confirmado, respire fundo,
            aguarde alguns minutos e tente novamente. Às vezes o banco e o gateway demoram
            um pouco para conversar entre si.
            <br /><br />
            Se algo parecer estranho ou você não conseguir acessar, pode falar comigo com
            o <strong>comprovante de pagamento</strong> em mãos — vou te ajudar a resolver.
          </p>
        </div>
      </section>
    </main>

    <footer class="site-footer">
      <div class="container footer-inner">
        <p class="footer-text">
          © <span id="year"></span> Música &amp; Ansiedade · Série Música &amp;
          Medicina · Octopus Axis
        </p>
      </div>
    </footer>

    <script>
      // Atualiza ano no rodapé
      document.getElementById('year').textContent = new Date().getFullYear();

      const form = document.getElementById('download-form');
      const statusEl = document.getElementById('download-status');
      const button = document.getElementById('download-button');
      const linkWrapper = document.getElementById('download-link-wrapper');
      const downloadLink = document.getElementById('download-link');

      function setStatus(message, type) {
        statusEl.textContent = message || '';
        statusEl.classList.remove('status-error', 'status-success', 'status-info');

        if (!message) return;

        if (type === 'error') {
          statusEl.classList.add('status-error');
        } else if (type === 'success') {
          statusEl.classList.add('status-success');
        } else {
          statusEl.classList.add('status-info');
        }
      }

      function setLoading(isLoading) {
        if (isLoading) {
          button.disabled = true;
          button.textContent = 'Verificando...';
        } else {
          button.disabled = false;
          button.textContent = 'Verificar e liberar download';
        }
      }

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        setLoading(true);
        setStatus('Verificando seu pedido…', 'info');
        linkWrapper.classList.add('hidden');

        const email = document.getElementById('email').value.trim();
        const orderId = document.getElementById('orderId').value.trim();

        if (!email) {
          setStatus('Por favor, preencha o e-mail usado na compra.', 'error');
          setLoading(false);
          return;
        }

        try {
          const params = new URLSearchParams();
          params.set('email', email);
          if (orderId) params.set('orderId', orderId);

          const response = await fetch('/api/download?' + params.toString(), {
            method: 'GET',
          });

          if (!response.ok) {
            setStatus(
              'Erro ao verificar seu pedido. Tente novamente em alguns instantes.',
              'error'
            );
            setLoading(false);
            return;
          }

          const data = await response.json();

          if (!data.found) {
            setStatus(
              'Não encontrei nenhum pedido para este e-mail. Verifique se digitou corretamente ou tente outro endereço que você usa com frequência.',
              'error'
            );
            setLoading(false);
            return;
          }

          if (!data.allowed || !data.ebookUrl) {
            const statusTexto = data.status || data.mpStatus || 'pendente';
            setStatus(
              'Seu pagamento ainda não foi confirmado (status: ' +
                statusTexto +
                '). Assim que for aprovado, o download será liberado automaticamente aqui.',
              'info'
            );
            setLoading(false);
            return;
          }

          // Tudo certo: download liberado
          setStatus(
            'Download liberado! O e-book deve abrir em uma nova aba. Se não abrir, use o botão abaixo.',
            'success'
          );

          downloadLink.href = data.ebookUrl;
          linkWrapper.classList.remove('hidden');

          // Redireciona automaticamente para o PDF
          window.location.href = data.ebookUrl;
        } catch (error) {
          console.error('Erro ao chamar /api/download:', error);
          setStatus(
            'Ocorreu um erro inesperado ao tentar liberar seu download. Tente novamente em alguns minutos.',
            'error'
          );
        } finally {
          setLoading(false);
        }
      });
    </script>
  </body>
</html>
