<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Download · E-book Música & Ansiedade</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="description"
      content="Área de download do e-book Música & Ansiedade — obrigado pela sua compra!"
    />

    <!-- Fontes modernas (mesmo padrão do site) -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Inter+Tight:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- CSS principal da landing -->
    <link rel="stylesheet" href="styles.css" />

    <!-- Estilo extra só para o cartão de agradecimento -->
    <style>
      .thankyou-hero {
        min-height: 70vh;
        display: flex;
        align-items: center;
      }

      .thankyou-card {
        max-width: 720px;
        margin: 0 auto;
        padding: 2.5rem 2rem;
        border-radius: 1.5rem;
        background: radial-gradient(circle at top left, #16343f, #020617);
        box-shadow: 0 22px 45px rgba(0, 0, 0, 0.6);
        color: #e5e7eb;
      }

      .thankyou-title {
        font-size: clamp(1.8rem, 3vw, 2.3rem);
        margin-bottom: 0.75rem;
      }

      .thankyou-email {
        font-weight: 600;
        color: #a7f3d0;
        margin: 0.25rem 0 1rem;
      }

      .thankyou-actions {
        margin-top: 2rem;
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .thankyou-note {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-top: 1.25rem;
      }

      .status-text {
        margin-top: 0.75rem;
        font-size: 0.95rem;
        line-height: 1.5;
      }

      .status-ok {
        color: #bbf7d0;
      }

      .status-warn {
        color: #fde68a;
      }

      .status-error {
        color: #fecaca;
      }

      .hidden {
        display: none !important;
      }
    </style>
  </head>

  <body class="page download-page">
    <!-- Cabeçalho igual ao resto do site -->
    <header class="site-header">
      <div class="container header-inner">
        <div class="logo-block">
          <div class="logo-mark">OA</div>
          <div class="logo-text">
            <span class="logo-small">Octopus Axis E-books</span>
            <span class="logo-sub">Série Música &amp; Medicina</span>
          </div>
        </div>
      </div>
    </header>

    <main class="thankyou-hero">
      <div class="container">
        <div class="thankyou-card">
          <p class="pill">Compra concluída · Música &amp; Ansiedade</p>

          <h1 class="thankyou-title" id="download-title">
            Obrigada por confiar no meu trabalho.
          </h1>

          <p id="download-message">
            Estamos confirmando seu pagamento e preparando o download seguro do
            e-book.
          </p>

          <p class="thankyou-email" id="buyer-email-display"></p>

          <p id="download-status" class="status-text status-warn">
            Buscando seu pedido…
          </p>

          <div class="thankyou-actions">
            <button
              id="retry-button"
              type="button"
              class="btn btn-primary hidden"
            >
              Abrir e-book novamente
            </button>

            <a href="index.html" class="btn btn-outline">
              Voltar para a página inicial
            </a>
          </div>

          <p class="thankyou-note">
            Se algo não funcionar ou o e-book não abrir, me escreva em
            <strong>mt.fernandazaguini@gmail.com</strong> com o comprovante de
            pagamento, que eu te ajudo pessoalmente.
          </p>
        </div>
      </div>
    </main>

    <footer class="site-footer">
      <div class="container footer-inner">
        <p class="footer-text">
          © <span id="year"></span> Música &amp; Ansiedade · Série Música &amp;
          Medicina · Octopus Axis
        </p>
      </div>
    </footer>

    <script>
  // Atualiza ano no rodapé
  document.getElementById("year").textContent = new Date().getFullYear();

  const titleEl = document.getElementById("download-title");
  const msgEl = document.getElementById("download-message");
  const statusEl = document.getElementById("download-status");
  const emailEl = document.getElementById("buyer-email-display");
  const retryBtn = document.getElementById("retry-button");

  function setStatus(message, mode) {
    statusEl.textContent = message || "";
    statusEl.classList.remove("status-ok", "status-warn", "status-error");

    if (!message) return;

    if (mode === "ok") statusEl.classList.add("status-ok");
    else if (mode === "error") statusEl.classList.add("status-error");
    else statusEl.classList.add("status-warn");
  }

  function getBuyerEmail() {
    // 1) tenta pegar da URL ?email=
    try {
      const url = new URL(window.location.href);
      const fromQuery = url.searchParams.get("email");
      if (fromQuery) return fromQuery.trim();
    } catch {}

    // 2) tenta pegar do localStorage salvo no checkout
    try {
      const stored = localStorage.getItem("buyer_email");
      if (stored) return stored.trim();
    } catch {}

    return null;
  }

  function getOrderId() {
    // 1) tenta pegar da URL ?orderId=
    try {
      const url = new URL(window.location.href);
      const fromQuery = url.searchParams.get("orderId");
      if (fromQuery) return fromQuery.trim();
    } catch {}

    return null;
  }

  async function iniciarDownload() {
    const email = getBuyerEmail();
    const orderId = getOrderId();

    // ✅ Agora o download exige email + orderId
    if (!email || !orderId) {
      msgEl.textContent =
        "Este link precisa vir do retorno do Mercado Pago para liberar o download com segurança.";
      setStatus(
        "Link incompleto. Volte ao checkout e clique em “Retornar ao site” após o pagamento.",
        "error"
      );
      emailEl.textContent = email ? email : "";
      return;
    }

    emailEl.textContent = email;
    setStatus("Procurando seu pedido no sistema…", "warn");

    try {
      const resp = await fetch(
        window.location.origin +
          "/api/download?email=" +
          encodeURIComponent(email) +
          "&orderId=" +
          encodeURIComponent(orderId),
        {
          method: "GET",
          cache: "no-store",
        }
      );

      let data;
      try {
        data = await resp.json();
      } catch {
        setStatus(
          "Não foi possível interpretar a resposta do servidor. Tente recarregar a página.",
          "error"
        );
        return;
      }

      if (!resp.ok) {
        setStatus(
          "Erro ao verificar seu pedido. Tente recarregar a página em alguns instantes.",
          "error"
        );
        console.error("Erro /api/download:", data);
        return;
      }

      if (!data.found) {
        setStatus(
          "Não encontrei nenhum pedido para este link. Confira se você voltou pelo Mercado Pago.",
          "error"
        );
        msgEl.textContent =
          "Se você tiver certeza de que pagou, me chame por e-mail com o comprovante.";
        return;
      }

      // Pagamento ainda não liberado
      if (!data.allowed || !data.ebookUrl) {
        setStatus(
          "Seu pagamento ainda está em análise ou não foi aprovado (status: " +
            (data.mpStatus || data.status || "pendente") +
            ").",
          "warn"
        );
        msgEl.textContent =
          "Assim que o pagamento for confirmado, você poderá voltar a esta página para baixar o e-book.";
        return;
      }

      // Tudo certo — download liberado
      setStatus("Pagamento confirmado! Vamos abrir o e-book automaticamente.", "ok");
      titleEl.textContent = "Obrigada por confiar no meu trabalho. Seu e-book está liberado!";
      msgEl.textContent =
        "O PDF deve abrir em instantes. Se não abrir, use o botão abaixo para abrir novamente.";

      const ebookUrl = data.ebookUrl;

      // Botão para reabrir caso o navegador bloqueie o redirect
      retryBtn.classList.remove("hidden");
      retryBtn.onclick = () => {
        window.open(ebookUrl, "_blank");
      };

      // Redireciona automaticamente para o PDF (pequeno delay para a pessoa ler o “Obrigada”)
      setTimeout(() => {
        window.location.href = ebookUrl;
      }, 1200);
    } catch (err) {
      console.error("Erro inesperado ao chamar /api/download:", err);
      setStatus(
        "Ocorreu um erro inesperado ao tentar liberar seu download. Tente recarregar a página em alguns minutos.",
        "error"
      );
    }
  }

  document.addEventListener("DOMContentLoaded", iniciarDownload);
</script>
  </body>
</html>
